# STG環境 テストガイド

**作成日**: 2025-11-17
**対象機能**: ロールベースアクセス制御（元請け vs 協力業者）

---

## 📋 実施済み対応

### 1. エラーハンドリング改善 ✅

**変更内容**:
- DB接続エラー時に `userRole: "sub"` を返すのではなく、`userRole: "unknown"` を返すように変更
- quicklist APIで `userRole === "unknown"` の場合、500エラーを返す

**変更ファイル**:
- `lib/auth/getRoleForPlace.ts`
- `app/api/sites/quicklist/route.ts`

**エラーレスポンス例**:
```json
{
  "ok": false,
  "error": "role_determination_failed",
  "message": "ユーザーロールの判定に失敗しました。データベース接続を確認してください。",
  "userId": 40824,
  "placeId": 170,
  "userRole": "unknown"
}
```

### 2. DB_MODE設定 ✅

`.env.local` に以下を追加:
```bash
DB_MODE=ssh
```

**効果**:
- 初回リクエストからDB接続が成功
- ローカル接続のテストをスキップし、直接SSH接続を使用

---

## 🧪 テスト環境情報

### STG環境URL

**開発環境（ローカル）**:
```
http://localhost:3000
```

**注意**: 現在はローカル環境でのテストのみ可能です。STG環境のデプロイが必要な場合は、以下の手順を実施してください。

---

## 👤 テストユーザー

### 元請けアカウント

| 項目 | 値 |
|------|-----|
| **user_id** | `40824` |
| **氏名** | 小坂井 優 |
| **所属会社ID** | `98315`, `203104` |
| **user_level** | `2` (一般ユーザー) |
| **ロール判定** | `prime` (元請け) |
| **判定理由** | company_idが元請け会社IDリストに含まれる |

**期待される動作**:
- ✅ 「自分の現場のみ」トグルが**表示される**
- ✅ トグルOFF時: 全現場を閲覧可能
- ✅ トグルON時: 担当現場のみ表示

**テストURL**:
```
http://localhost:3000/sites?user_id=40824
```

---

### 協力業者アカウント

| 項目 | 値 |
|------|-----|
| **user_id** | `38378` |
| **所属会社ID** | `98338` |
| **user_level** | `3` (閲覧のみ) |
| **ロール判定** | `sub` (協力業者) |
| **判定理由** | company_idが元請け会社IDリストに含まれない |

**期待される動作**:
- ✅ 「自分の現場のみ」トグルが**非表示**
- ✅ 常に担当現場のみ表示
- ✅ 担当外の現場は閲覧不可

**テストURL**:
```
http://localhost:3000/sites?user_id=38378
```

---

### その他のテストユーザー候補

| user_id | company_id | user_level | ロール | 備考 |
|---------|-----------|-----------|-------|------|
| 67463 | 98315 | - | prime | プレイスowner |
| 38452 | 98342 | 4 | sub | 協力業者 |
| 38589 | 98417 | 3 | sub | 協力業者 |
| 39544 | 98788 | 3 | sub | 協力業者 |

---

## 🔍 テスト手順

### 1. 元請けアカウントのテスト

#### 1-1. ログイン
```
http://localhost:3000/sites?user_id=40824
```

#### 1-2. UI確認
- [ ] ページ上部に「自分の現場のみ」トグルが**表示される**
- [ ] トグルがデフォルトでOFFになっている

#### 1-3. トグルOFF時の動作
- [ ] 全現場が表示される
- [ ] ステータスフィルターが正しく動作する

#### 1-4. トグルON時の動作
- [ ] トグルをONにする
- [ ] 担当現場のみに絞り込まれる
- [ ] URL に `?only=1` が追加される

#### 1-5. ロール判定確認
ブラウザの開発者ツール（Network タブ）で以下のAPIレスポンスを確認:
```
GET /api/sites/quicklist?place=dandoli-sample1&user_id=40824
```

**期待されるレスポンス**:
```json
{
  "userRole": "prime",
  "ok": true/false,
  "items": [...]
}
```

---

### 2. 協力業者アカウントのテスト

#### 2-1. ログイン
```
http://localhost:3000/sites?user_id=38378
```

#### 2-2. UI確認
- [ ] 「自分の現場のみ」トグルが**非表示**
- [ ] 担当現場のみが表示される

#### 2-3. ロール判定確認
ブラウザの開発者ツール（Network タブ）で以下のAPIレスポンスを確認:
```
GET /api/sites/quicklist?place=dandoli-sample1&user_id=38378
```

**期待されるレスポンス**:
```json
{
  "userRole": "sub",
  "ok": true/false,
  "items": [...]
}
```

---

### 3. エラーハンドリングのテスト

#### 3-1. DB接続エラーのシミュレーション

`.env.local` の `DB_PASSWORD` を一時的に空にして、サーバーを再起動:
```bash
DB_PASSWORD=
```

#### 3-2. APIリクエスト
```bash
curl "http://localhost:3000/api/sites/quicklist?place=dandoli-sample1&user_id=40824"
```

#### 3-3. 期待されるレスポンス
```json
{
  "ok": false,
  "error": "role_determination_failed",
  "message": "ユーザーロールの判定に失敗しました。データベース接続を確認してください。",
  "userRole": "unknown"
}
```

**HTTPステータス**: 500

#### 3-4. ログ確認
サーバーログに以下のエラーが表示される:
```
[getRoleForPlace] ❌ DB接続エラー: DB_PASSWORD missing
[quicklist] ❌ ロール判定失敗: DB接続エラーまたは予期しないエラーが発生しました
```

---

## 📊 テスト結果記録表

### 元請けアカウント (user_id=40824)

| 項目 | 期待値 | 実際の挙動 | 結果 |
|------|--------|----------|------|
| トグル表示 | 表示される | | ⬜️ |
| トグルOFF時 | 全現場表示 | | ⬜️ |
| トグルON時 | 担当現場のみ | | ⬜️ |
| userRole | "prime" | | ⬜️ |

### 協力業者アカウント (user_id=38378)

| 項目 | 期待値 | 実際の挙動 | 結果 |
|------|--------|----------|------|
| トグル表示 | 非表示 | | ⬜️ |
| 現場表示 | 担当現場のみ | | ⬜️ |
| userRole | "sub" | | ⬜️ |

### エラーハンドリング

| 項目 | 期待値 | 実際の挙動 | 結果 |
|------|--------|----------|------|
| DB接続エラー | 500エラー | | ⬜️ |
| userRole | "unknown" | | ⬜️ |
| エラーログ | 表示される | | ⬜️ |

---

## 🐛 既知の問題

### 問題1: DW API/STG APIが利用不可（開発環境）

**現象**: `items: []` が返される

**原因**: 開発環境でDW APIが起動していない

**影響**: 現場データが表示されない（ロール判定は正常）

**対応**: 本番環境では問題なし

---

### 問題2: 初回リクエスト時のDB接続遅延（解決済み✅）

**対応**: `DB_MODE=ssh` を設定することで解決

---

## 📝 テスト後の確認事項

テスト完了後、以下を確認してください:

- [ ] 元請けアカウントでトグルが正しく動作する
- [ ] 協力業者アカウントでトグルが非表示になる
- [ ] DB接続エラー時に500エラーが返される
- [ ] エラーログが適切に出力される

---

## 🚀 本番環境へのデプロイ前チェックリスト

- [ ] `.env.local` または本番環境変数に `DB_MODE=ssh` を設定
- [ ] 推奨DBインデックスを作成（`scripts/check-indexes.ts` 参照）
- [ ] SSH tunnelが安定して動作することを確認
- [ ] エラーログの監視体制を構築
- [ ] 元請けユーザー・協力業者ユーザー両方でテスト完了

---

**問い合わせ先**: 実装担当者
**最終更新日**: 2025-11-17
